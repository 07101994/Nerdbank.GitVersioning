<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFrameworks>netcoreapp1.0;net45</TargetFrameworks>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>

    <PackageId>Nerdbank.GitVersioning</PackageId>
    <title>Nerdbank.GitVersioning</title>
    <authors>Andrew Arnott</authors>
    <owners>andarno</owners>
    <requireLicenseAcceptance>false</requireLicenseAcceptance>
    <PackageProjectUrl>http://github.com/aarnott/Nerdbank.GitVersioning</PackageProjectUrl>
    <description>Stamps your assemblies with semver 2.0 compliant git commit specific version information and provides NuGet versioning information as well.</description>
    <PackageTags>git commit versioning version assemblyinfo</PackageTags>

    <NoPackageAnalysis>true</NoPackageAnalysis>

    <!-- Note that https://github.com/NuGet/Home/issues/4694 prevents this from actually working. -->
    <developmentDependency>true</developmentDependency>

    <!-- We're going to include it by virtue of sending the whole bin dir to the build folder. -->
    <IncludeBuildOutput>false</IncludeBuildOutput>

    <CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>
  </PropertyGroup>

  <Target Name="SetNuSpecProperties" BeforeTargets="GenerateNuspec" DependsOnTargets="GetBuildVersion">
    <PropertyGroup>
      <PackageLicenseUrl>https://raw.githubusercontent.com/AArnott/Nerdbank.GitVersioning/$(GitCommitIdShort)/LICENSE.txt</PackageLicenseUrl>
    </PropertyGroup>
  </Target>

  <Target Name="CollectRuntimeOutputs" BeforeTargets="_GetPackageFiles">
    <ItemGroup>
      <Content Include="$(OutputPath)net45\*.dll;$(OutputPath)net45\*.dll.config"
               Exclude="$(OutputPath)net45\Microsoft.Build.*.dll">
        <Pack>true</Pack>
        <PackagePath>build\MSBuildFull\</PackagePath>
      </Content>
      <Content Include="$(OutputPath)netcoreapp1.0\LibGit2Sharp.dll*"
               Include="$(OutputPath)netcoreapp1.0\MSBuildExtensionTask.dll"
               Include="$(OutputPath)netcoreapp1.0\Nerdbank.GitVersioning.*dll"
               Include="$(OutputPath)netcoreapp1.0\Newtonsoft.Json.dll"
               Include="$(OutputPath)netcoreapp1.0\Validation.dll"
               >
        <Pack>true</Pack>
        <PackagePath>build\MSBuildCore\</PackagePath>
      </Content>
    </ItemGroup>
    <MSBuild Projects="$(MSBuildProjectFullPath)"
             Targets="GetLibGitNativeBinaries"
             BuildInParallel="$(BuildInParallel)"
             Properties="TargetFramework=%(_TargetFrameworks.Identity);BuildProjectReferences=false;">
      <Output TaskParameter="TargetOutputs" ItemName="None" />
    </MSBuild>
  </Target>

  <Target Name="GetLibGitNativeBinaries" Outputs="@(LibGitNativeBinaries)">
    <!-- Package up the libgit2 native binaries -->
    <ItemGroup>
      <!-- Adapt the copy behavior  -->
      <LibGitNativeBinaries Include="@(None)" Condition=" '%(None.CopyToOutputDirectory)' == 'PreserveNewest' ">
        <Pack>true</Pack>
        <PackagePath>build\%(None.Link)</PackagePath>
      </LibGitNativeBinaries>
    </ItemGroup>
  </Target>

  <ItemGroup>
    <None Include="build\**">
      <Pack>true</Pack>
      <PackagePath>build\</PackagePath>
    </None>
    <None Include="buildCrossTargeting\**">
      <Pack>true</Pack>
      <PackagePath>buildCrossTargeting\</PackagePath>
    </None>
    <None Include="tools\**">
      <Pack>true</Pack>
      <PackagePath>tools\</PackagePath>
    </None>
    <None Include="readme.txt">
      <Pack>true</Pack>
      <PackagePath>readme.txt</PackagePath>
    </None>
  </ItemGroup>

  <ItemDefinitionGroup>
    <PackageReference>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <ProjectReference>
      <PrivateAssets>all</PrivateAssets>
    </ProjectReference>
  </ItemDefinitionGroup>

  <ItemGroup>
    <PackageReference Include="Nerdbank.GitVersioning.LKG" Version="1.6.20-beta-gfea83a8c9e" />
    <PackageReference Include="NuProj.Common" Version="0.11.14-beta" />
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\MSBuildExtensionTask\MSBuildExtensionTask.csproj" />
    <ProjectReference Include="..\NerdBank.GitVersioning\NerdBank.GitVersioning.csproj" />
  </ItemGroup>
  <ItemGroup>
    <Compile Include="..\Shared\**\*.cs" LinkBase="Shared" />
  </ItemGroup>
</Project>